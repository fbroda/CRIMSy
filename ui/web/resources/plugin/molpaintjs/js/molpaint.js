function Action(t,e,o,i){this.actionType=t,this.newObject=o,this.oldObject=i,this.objectType=e}function ActionList(){this.actions=[],this.addAction=function(t){this.actions.push(t)},this.addActionList=function(t){for(var e in t.actions)this.actions.push(t.actions[e])},this.getActions=function(){return this.actions}}function Atom(){this.bbox=null,this.bonds={},this.coordX,this.coordY,this.coordZ,this.charge=0,this.radical=0,this.id=null,this.index,this.selected=0,this.stereo=0,this.temp=0,this.type,this.changeIsotope=function(t){var e=this.type.getIsotope().getAtomicNumber()-1,o=this.type.getIsotope().getMassExact(),i=null,s=100;for(var n of Elements.instance.elements[e]){var r=(n.getMassExact()-o)*t;r>0&&r<s&&(s=r,i=n)}if(null!=i){var a=new AtomType;return a.setIsotope(i),a.setColor(i.getColor()),this.type=a,!0}return!1},this.chargeDecrement=function(){this.charge-=1},this.chargeIncrement=function(){this.charge+=1},this.addBond=function(t){this.bonds[t]=t},this.copy=function(){var t=new Atom;return t.coordX=this.coordX,t.coordY=this.coordY,t.coordZ=this.coordZ,t.charge=this.charge,t.radical=this.radical,t.id=this.id,t.index=this.index,t.selected=this.selected,t.stereo=this.stereo,t.temp=this.temp,t.type=this.type,t.bonds=this.copyBonds(),t},this.copyBonds=function(){var t={};for(var e in this.bonds)t[e]=e;return t},this.delBond=function(t){delete this.bonds[t]},this.getBonds=function(){return this.bonds},this.getCharge=function(){return this.charge},this.getHydrogenCount=function(t){var e=0;for(var o in this.bonds)switch(t.getBond(o).getType()){case"1":e-=1;break;case"2":e-=2;break;case"3":e-=3}switch(this.type.isotope.symbol){case"N":e+=3+this.charge;break;case"O":case"S":e+=2+this.charge}return e>0?e:0},this.getId=function(){return this.id},this.getIndex=function(){return this.index},this.getRadical=function(){return this.radical},this.getSelected=function(){return this.selected},this.getStereo=function(){return this.stereo},this.getTemp=function(){return this.temp},this.getType=function(){return this.type},this.setCharge=function(t){this.charge=t},this.setId=function(t){this.id=t},this.setIndex=function(t){this.index=t},this.setRadical=function(t){this.radical=t},this.setSelected=function(t){this.selected=t},this.setStereo=function(t){this.stereo=t},this.setTemp=function(t){this.temp=t},this.setType=function(t){this.type=t}}function AtomTool(t,e,o){this.context=t,this.distMax=e.distMax,this.id=o,this.atom=null,this.abort=function(){Tools.abort(this),this.atom=null},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax),n=new AtomType;n.setIsotope(this.context.currentElement),n.setColor(this.context.currentElement.getColor());var r=new ActionList,a=null;null==s?(this.atom=new Atom,this.atom.coordX=i.x,this.atom.coordY=i.y,this.atom.coordZ=0,this.atom.setType(n),this.context.molecule.addAtom(this.atom,null),r.addAction(new Action("ADD","ATOM",this.atom,null))):(a=this.context.molecule.getAtom(s),this.atom=a.copy(),this.atom.setType(n),this.context.molecule.replaceAtom(this.atom),r.addAction(new Action("UPD","ATOM",this.atom,a))),this.context.history.appendAction(r),this.context.draw(),this.atom=null},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){},this.setup=function(){var t=this.context.contextId+"_customElement",e=document.getElementById(t),o=this.context.currentElement.getSymbol();switch(o){case"H":case"C":case"N":case"O":e.innerHTML="";break;default:e.innerHTML=o,e.style.color=this.context.currentElement.getColor()}}}function AtomType(){this.color,this.label,this.isotope,this.getColor=function(){return this.color},this.getIsotope=function(){return this.isotope},this.getLabel=function(){return this.label},this.setColor=function(t){this.color=t},this.setIsotope=function(t){this.isotope=t},this.setLabel=function(t){this.label=t}}function Bond(){this.atomA=null,this.atomB=null,this.color=null,this.id=null,this.index=null,this.selected=0,this.stereo="0",this.temp=0,this.type=null,this.copy=function(){var t=new Bond;return t.atomA=this.atomA,t.atomB=this.atomB,t.color=this.color,t.id=this.id,t.index=this.index,t.selected=this.selected,t.temp=this.temp,t.type=this.type,t.stereo=this.stereo,t},this.getAtomA=function(){return this.atomA},this.getAtomB=function(){return this.atomB},this.getColor=function(){return this.color},this.getId=function(){return this.id},this.getIndex=function(){return this.index},this.getSelected=function(){return this.selected},this.getStereo=function(){return this.stereo},this.getTemp=function(){return this.temp},this.getType=function(){return this.type},this.setAtomA=function(t){this.atomA=t},this.setAtomB=function(t){this.atomB=t},this.setColor=function(t){this.color=t},this.setId=function(t){this.id=t},this.setIndex=function(t){this.index=t},this.setSelected=function(t){this.selected=t},this.setStereo=function(t){""!=t&&(this.stereo=t)},this.setTemp=function(t){this.temp=t},this.setType=function(t){this.type=t},this.swap=function(){[this.atomA,this.atomB]=[this.atomB,this.atomA]}}function BondTool(t,e,o,i,s){this.context=t,this.distMax=e.distMax,this.bondType=o,this.stereoType=i,this.id=s,this.atomA=null,this.abort=function(){Tools.abort(this);var t=this.context.contextId+"_currentBond";document.getElementById(t).className="inactiveTool",this.atomA=null},this.onClick=function(t,e,o){null!=this.atomA&&(this.atomA=null,this.actionList.addActionList(this.context.molecule.clearTemp()),this.context.history.appendAction(this.actionList),this.context.draw())},this.onMouseDown=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectBond(i,this.distMax),n=this.context.molecule.selectAtom(i,this.distMax);if(this.actionList=new ActionList,null==n)if(s.length>0){var r=this.context.molecule.bonds[s[0]],a=r.copy(),c=!1;r.getType()!=this.bondType||r.getStereo()!=this.stereoType?(r.setType(this.bondType),r.setStereo(this.stereoType),c=!0):"0"==this.stereoType&&"2"!=r.getType()||(r.swap(),c=!0),c&&(this.actionList.addAction(new Action("UPD","BOND",r,a)),this.context.history.appendAction(this.actionList),this.context.draw())}else{this.atomA=new Atom,this.atomA.coordX=i.x,this.atomA.coordY=i.y,this.atomA.coordZ=0;var h=new AtomType;h.setIsotope(this.context.currentElement),h.setColor(this.context.currentElement.getColor()),this.atomA.setType(h),this.context.molecule.addAtom(this.atomA,null),n=this.atomA.id,this.actionList.addAction(new Action("ADD","ATOM",this.atomA,null))}else this.atomA=this.context.molecule.getAtom(n);this.onMouseMove(t,e,o)},this.onMouseMove=function(t,e,o){if(null!=this.atomA){var i=this.context.view.getCoordReverse(t,e);this.context.molecule.delTemp();var s,n=this.context.molecule.selectAtom(i,this.distMax);if(null==n||n==this.atomA.getId()){var r=i.x-this.atomA.coordX,a=i.y-this.atomA.coordY,c=Math.sqrt(r*r+a*a);c=c<.01?1:c;var h=180*Math.asin(-a/c)/Math.PI,l=180*Math.acos(r/c)/Math.PI;l=h<0?l:360-l;var d=Math.floor(l/30);(s=new Atom).coordX=this.atomA.coordX+this.context.rasterX[d],s.coordY=this.atomA.coordY+this.context.rasterY[d],s.coordZ=0,s.setTemp(1);var u=new AtomType;u.setIsotope(this.context.currentElement),u.setColor(this.context.currentElement.getColor()),s.setType(u),this.context.molecule.addAtom(s,null)}else s=this.context.molecule.getAtom(n);var m=new Bond;m.setAtomA(this.atomA),m.setAtomB(s),m.setType(this.bondType),m.setStereo(this.stereoType),m.setTemp(1),this.context.molecule.addBond(m,null),this.context.draw()}},this.setup=function(){var t=this.context.contextId+"_"+this.id,e=this.context.contextId+"_currentBond";icon=document.getElementById(e),icon.src=document.getElementById(t).src,icon.className="activeTool",this.context.currentBondTool=this}}function Box(t,e,o,i){this.minX=t<o?t:o,this.minY=e<i?e:i,this.maxX=t<o?o:t,this.maxY=e<i?i:e,this.join=function(t){this.minX=this.minX<t.minX?this.minX:t.minX,this.minY=this.minY<t.minY?this.minY:t.minY,this.maxX=this.maxX>t.maxX?this.maxX:t.maxX,this.maxY=this.maxY>t.maxY?this.maxY:t.maxY},this.draw=function(t){t.moveTo(this.minX,this.minY),t.lineTo(this.minX,this.maxY),t.lineTo(this.maxX,this.maxY),t.lineTo(this.maxX,this.minY),t.lineTo(this.minX,this.minY),t.stroke(),t.beginPath()},this.clip=function(t,e,o){var i=0;switch(i+=e>0?1:0,i+=0==e?2:0,i+=e<0?4:0,i+=o>0?8:0,i+=0==o?16:0,i+=o<0?32:0){case 9:return this.clip1(t,e,o);case 10:return{x:t.x,y:this.minY};case 12:return this.clip2(t,e,o);case 17:return{x:this.minX,y:t.y};case 20:return{x:this.maxX,y:t.y};case 33:return this.clip4(t,e,o);case 34:return{x:t.x,y:this.maxY};case 36:return this.clip3(t,e,o);default:alert("Box.clip(): internal error")}},this.clip1=function(t,e,o){var i=t.x-this.minX,s=t.y-this.minY,n=e/o;return n<i/s?{x:t.x-n*s,y:this.minY}:{x:this.minX,y:t.y-i/n}},this.clip2=function(t,e,o){var i=this.maxX-t.x,s=t.y-this.minY,n=-e/o;return n<i/s?{x:t.x+n*s,y:this.minY}:{x:this.maxX,y:t.y-i/n}},this.clip3=function(t,e,o){var i=this.maxX-t.x,s=this.maxY-t.y,n=e/o;return n<i/s?{x:t.x+n*s,y:this.maxY}:{x:this.maxX,y:t.y+i/n}},this.clip4=function(t,e,o){var i=t.x-this.minX,s=this.maxY-t.y,n=-e/o;return n<i/s?{x:t.x-n*s,y:this.maxY}:{x:this.minX,y:t.y+i/n}}}function ChainTool(t,e){this.id="chain",this.context=t,this.distMax=e.distMax,this.origin=null,this.atomA=null,this.abort=function(){this.origin=null,Tools.abort(this)},this.onClick=function(t,e,o){this.atomA=null,this.actionList.addActionList(this.context.molecule.clearTemp()),this.context.history.appendAction(this.actionList),this.context.draw()},this.onMouseDown=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);if(this.actionList=new ActionList,null==s){this.atomA=new Atom,this.atomA.coordX=i.x,this.atomA.coordY=i.y,this.atomA.coordZ=0;var n=new AtomType;n.setIsotope(Elements.instance.getElement("C")),n.setColor(Elements.instance.getElement("C").getColor()),this.atomA.setType(n),this.context.molecule.addAtom(this.atomA,null),s=this.atomA.id,this.actionList.addAction(new Action("ADD","ATOM",this.atomA,null))}else this.atomA=this.context.molecule.getAtom(s);this.context.draw()},this.onMouseMove=function(t,e,o){if(null!=this.atomA){this.context.molecule.delTemp();var i=this.context.view.getCoordReverse(t,e),s=i.x-this.atomA.coordX,n=i.y-this.atomA.coordY,r=Math.sqrt(s*s+n*n);r=r<.01?1:r;var a=180*Math.asin(-n/r)/Math.PI,c=180*Math.acos(s/r)/Math.PI;c=a<0?c:360-c;var h=Math.floor(c/30),l=Math.ceil(c/30);h==l?l+=2:l++;var d=0,u=c/30-h>.5?1:0;s=0,n=0,dbg="";var m=this.atomA;do{var p=new Atom,g=d%2==u?h:l;d++,s+=this.context.rasterX[g],n+=this.context.rasterY[g],p.coordX=this.atomA.coordX+s,p.coordY=this.atomA.coordY+n,p.coordZ=0,p.setTemp(1);var f=new AtomType;f.setIsotope(Elements.instance.getElement("C")),f.setColor(Elements.instance.getElement("C").getColor()),p.setType(f),this.context.molecule.addAtom(p,null);var w=new Bond;w.setAtomA(m),w.setAtomB(p),w.setType("1"),w.setTemp(1),this.context.molecule.addBond(w,null),m=p}while(r>Math.sqrt(s*s+n*n));this.context.draw()}}}function ChargeDecTool(t,e){this.id="minus",this.context=t,this.distMax=e.distMax,this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);null!=s&&this.context.molecule.atoms[s].chargeDecrement(),this.context.draw()},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){}}function ChargeIncTool(t,e){this.id="plus",this.context=t,this.distMax=e.distMax,this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);null!=s&&this.context.molecule.atoms[s].chargeIncrement(),this.context.draw()},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){}}var contextRegistry={};function Context(t,e,o){this.contextId=t,this.molpaint=o,this.properties=new DefaultProperties(e),this.currentElement=Elements.instance.getElement("C"),this.currentTemplate="benzene",this.medianBondLength=1.5,this.rasterX=[],this.rasterY=[],this.tools=null,this.currentTool=null,this.currentBondTool=null,this.history=new History(t,this.properties),this.molecule=new Molecule,contextRegistry[t]=this,this.view=new View(t,this.properties),this.widget=new Widget(t,this.properties,o),this.widget.renderWidget(),this.debug=function(t){null!=this.properties.debugId&&(document.getElementById(this.properties.debugId).innerHTML=t)},this.draw=function(){new Draw(this.view,this.molecule).draw()},this.getHistory=function(){return this.history},this.getMolecule=function(){return this.molecule},this.getView=function(){return this.view},this.init=function(){var t=this;this.setupTools(this.properties),new Promise(function(e,o){window.setTimeout(function(){e(t)},120)}).then(function(t){t.view.init(),"1"!=t.properties.viewer&&(t.history.updateIcons(),t.setCurrentTool(t.tools.pointerTool),t.widget.initEvents(t)),t.initRaster(),t.draw()})},this.initRaster=function(){this.medianBondLength=this.molecule.computeBondLengths();for(var t=0;t<15;t++)this.rasterX[t]=Math.cos(t*Math.PI/6)*this.medianBondLength,this.rasterY[t]=Math.sin(t*Math.PI/6)*this.medianBondLength},this.pasteMolecule=function(t,e){var o=new MDLv2000Reader(t);o.read();var i=o.getMolecule(),s=new ActionList,n=i.getAtoms();for(var r in n){var a=n[r];a.selected=e,this.molecule.addAtom(a,null),s.addAction(new Action("ADD","ATOM",a,null))}var c=i.getBonds();for(var r in c){var h=c[r];h.selected=e,this.molecule.addBond(h,null),s.addAction(new Action("ADD","BOND",h,null))}return this.history.appendAction(s),this.initRaster(),this.draw(),s},this.setCurrentTool=function(t){this.currentTool.abort(),this.currentTool=t,Tools.setup(t)},this.setMolecule=function(t){var e=new MDLv2000Reader(t);return e.read(),this.molecule=e.getMolecule(),this.molecule.center(),this.view.center(),this.initRaster(),this.view.setMolScale(this.properties.molScaleDefault/this.medianBondLength),this},this.setupTools=function(){"1"!=this.properties.viewer?(this.tools={pointerTool:new PointerTool(this,this.properties),slideTool:new SlideTool(this),eraserTool:new EraserTool(this,this.properties),singleBondTool:new BondTool(this,this.properties,"1","0","single_bond"),doubleBondTool:new BondTool(this,this.properties,"2","0","double_bond"),tripleBondTool:new BondTool(this,this.properties,"3","0","triple_bond"),solidWedgeTool:new BondTool(this,this.properties,"1","1","solid_wedge"),hashedWedgeTool:new BondTool(this,this.properties,"1","6","hashed_wedge"),isotopeTool:new IsotopeTool(this,this.properties),radicalTool:new RadicalTool(this,this.properties),chainTool:new ChainTool(this,this.properties),chargeIncTool:new ChargeIncTool(this,this.properties),chargeDecTool:new ChargeDecTool(this,this.properties),hydrogenAtomTool:new AtomTool(this,this.properties,"hydrogen"),carbonAtomTool:new AtomTool(this,this.properties,"carbon"),nitrogenAtomTool:new AtomTool(this,this.properties,"nitrogen"),oxygenAtomTool:new AtomTool(this,this.properties,"oxygen"),customElementTool:new AtomTool(this,this.properties,"customElement"),templateTool:new TemplateTool(this,this.properties,"template")},this.currentTool=this.tools.pointerTool,this.currentBondTool=this.tools.singleBondTool,this.tools.templateTool.setTemplate("benzene",this.molpaint.getTemplate("benzene"))):(this.tools={nullTool:new NullTool(this)},this.currentTool=this.tools.nullTool,this.currentBondTool=this.tools.nullTool)}}function DefaultProperties(t){this.bondLength=1.5,this.distMax=.1,this.fontFamily="SansSerif",this.fontSize=16,this.iconSize=32,this.installPath="",this.molScaleDefault=33,this.sizeX=400,this.sizeY=400,this.subscriptFactor=.7,this.setProperties=function(t){if(null!=t)for(var e in t)this[e]=t[e]},this.setProperties(t)}function Draw(t,e){this.view=t,this.molecule=e,this.draw=function(){this.view.init();var t=this.view.getContext();t.clearRect(0,0,this.view.getSizeX(),this.view.getSizeY()),t.beginPath(),t.fillStyle="#000000",t.strokeStyle="#000000",t.lineWidth=1,this.drawAtoms(),this.drawBonds(),t.beginPath()},this.drawAtoms=function(){var t=this.molecule.getAtoms();for(var e in t){var o=t[e];o.selected&&this.drawAtomSelection(o),"C"!=o.getType().getIsotope().getSymbol()||0!=o.getCharge()||0!=o.getRadical()||0!=o.getType().getIsotope().getIsotope()||0==Object.keys(o.getBonds()).length?this.drawSingleAtom(o):o.bbox=null}},this.drawAtomSelection=function(t){var e=this.view.getContext(),o=this.view.getCoord(t),i=.6*this.view.getFontSize();e.save(),e.lineWidth=4,2==t.selected?e.strokeStyle="#22ff22":e.strokeStyle="#ff2222",e.moveTo(o.x+i,o.y),e.arc(o.x,o.y,i,0,2*Math.PI),e.stroke(),e.restore(),e.beginPath()},this.drawBonds=function(){var t=this.molecule.getBonds();for(var e in t){var o=t[e];switch(o.selected&&this.drawBondSelection(o),o.getType()){case"1":this.drawSingleBond(o);break;case"2":this.drawDoubleBond(o);break;case"3":this.drawTripleBond(o);break;default:alert("unknown bond type: "+o.getType())}}},this.drawBondSelection=function(t){var e=this.view.getContext(),o=t.getAtomA(),i=t.getAtomB(),s=this.view.getCoord(o),n=this.view.getCoord(i),r=s.x-n.x,a=s.y-n.y;null!=o.bbox&&(s=o.bbox.clip(s,r,a)),null!=i.bbox&&(n=i.bbox.clip(n,-r,-a)),e.save(),e.lineWidth=4,2==t.selected?e.strokeStyle="#22ff22":e.strokeStyle="#ff2222",e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.stroke(),e.restore(),e.beginPath()},this.drawSingleAtom=function(t){var e=this.view.getContext(),o=t.getType(),i=o.getIsotope().getSymbol(),s=t.getCharge(),n=t.getRadical(),r=t.getHydrogenCount(this.molecule);this.view.setFont();var a=e.measureText(i).width,c=this.view.getFontSize(),h=this.view.getCoord(t),l=h.x-a/2,d=h.y;t.bbox=new Box(l-1,d-c/2,l+a+1,d+c/2+1),e.fillStyle=o.getColor(),e.fillText(i,l,d+c/2-2);var u=0,m=l+a,p=d-.2*c;if(t.getType().getIsotope().getIsotope()>0){this.view.setSubscript();var g=t.getType().getIsotope().getMass(),f=e.measureText(g).width,w=l-f,x=p,v=new Box(w,x,w+f+1,x-this.view.getSubscriptSize()-1);t.bbox.join(v),e.fillStyle=o.getColor(),e.fillText(g,w,x)}if(0!=s||0!=n){this.view.setSubscript();g=this.getChargeLabel(s,n),v=new Box(m,p,m+(u=e.measureText(g).width)+1,p-this.view.getSubscriptSize()-1);t.bbox.join(v),e.fillStyle=o.getColor(),e.fillText(g,m,p)}var b=e.measureText("H").width,y=c,I=m+u,T=d;if(r>0&&"C"!=i){this.view.setFont(),b=e.measureText("H").width,e.fillStyle=o.getColor(),e.fillText("H",I,T+y/2-2);v=new Box(I,T,I+b+1,T-y-1);if(t.bbox.join(v),r>1){this.view.setSubscript();g=r+" ";v=new Box(I+=b,T=d+.8*c,I+(b=e.measureText(g).width),T-(y=this.view.getSubscriptSize())-1),t.bbox.join(v),e.fillStyle=o.getColor(),e.fillText(g,I,T)}}},this.drawDoubleBond=function(t){var e=this.view.getContext(),o=t.getAtomA(),i=t.getAtomB(),s=this.view.getCoord(o),n=this.view.getCoord(i),r=s.x-n.x,a=s.y-n.y,c=this.view.molScale/(8*Math.sqrt(r*r+a*a)),h={x:s.x-c*(a+r),y:s.y+c*(r-a)},l={x:n.x-c*(a-r),y:n.y+c*(r+a)};null!=o.bbox&&(s=o.bbox.clip(s,r,a),h=o.bbox.clip(h,r,a)),null!=i.bbox&&(n=i.bbox.clip(n,-r,-a),l=i.bbox.clip(l,-r,-a)),e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.moveTo(h.x,h.y),e.lineTo(l.x,l.y),e.stroke(),e.beginPath()},this.drawSingleBond=function(t){var e=this.view.getContext(),o=t.getAtomA(),i=t.getAtomB(),s=this.view.getCoord(o),n=this.view.getCoord(i),r=s.x-n.x,a=s.y-n.y,c=this.view.molScale/(12*Math.sqrt(r*r+a*a));switch(null!=o.bbox&&(s=o.bbox.clip(s,r,a)),null!=i.bbox&&(n=i.bbox.clip(n,-r,-a)),e.moveTo(s.x,s.y),t.getStereo()){case"0":e.lineTo(n.x,n.y),e.stroke();break;case"1":var h={x:n.x-c*a,y:n.y+c*r},l={x:n.x+c*a,y:n.y-c*r};e.lineTo(h.x,h.y),e.lineTo(l.x,l.y),e.lineTo(s.x,s.y),e.fillStyle="#000000",e.fill();break;case"6":e.setLineDash([2,3]),e.lineWidth=6,e.lineTo(n.x,n.y),e.stroke(),e.lineWidth=1,e.setLineDash([]);break;default:e.lineTo(n.x,n.y),e.stroke()}e.beginPath()},this.drawTripleBond=function(t){var e=this.view.getContext(),o=t.getAtomA(),i=t.getAtomB(),s=this.view.getCoord(o),n=this.view.getCoord(i),r=s.x-n.x,a=s.y-n.y,c=this.view.molScale/(8*Math.sqrt(r*r+a*a)),h={x:s.x-c*(a+r),y:s.y+c*(r-a)},l={x:n.x-c*(a-r),y:n.y+c*(r+a)},d={x:s.x+c*(a-r),y:s.y-c*(r+a)},u={x:n.x+c*(a+r),y:n.y-c*(r-a)};null!=o.bbox&&(s=o.bbox.clip(s,r,a),h=o.bbox.clip(h,r,a),d=o.bbox.clip(d,r,a)),null!=i.bbox&&(n=i.bbox.clip(n,-r,-a),l=i.bbox.clip(l,-r,-a),u=i.bbox.clip(u,-r,-a)),e.moveTo(s.x,s.y),e.lineTo(n.x,n.y),e.moveTo(h.x,h.y),e.lineTo(l.x,l.y),e.moveTo(d.x,d.y),e.lineTo(u.x,u.y),e.stroke(),e.beginPath()},this.getChargeLabel=function(t,e){var o="";switch(t){case 1:o="+";break;case-1:o="-";break;case 0:break;default:o=Math.abs(t)+(t>0?"+":"-")}switch(e){case 1:o+=":";break;case 2:o+="^";break;case 3:o+="^^"}return o}}function Elements(){this.elements=[[new Isotope(1,1,1,"H",1,0,1.008,"#666666"),new Isotope(1,1,1,"H",1,1,1.00782503223,"#666666"),new Isotope(1,1,1,"D",2,1,2.01410177812,"#666666"),new Isotope(1,1,1,"T",3,1,3.01604927791,"#666666")],[new Isotope(2,1,18,"He",4,0,4.002602,"#000000"),new Isotope(2,1,18,"He",3,1,3.0160293191,"#000000"),new Isotope(2,1,18,"He",4,1,4.00260325415,"#000000")],[new Isotope(3,2,1,"Li",7,0,6.94,"#ff0000"),new Isotope(3,2,1,"Li",6,1,6.015122795,"#ff0000"),new Isotope(3,2,1,"Li",7,1,7.016004555,"#ff0000")],[new Isotope(4,2,2,"Be",9,0,9.0121831,"#ff0000"),new Isotope(4,2,2,"Be",7,1,7.01692983,"#ff0000"),new Isotope(4,2,2,"Be",9,1,9.012182,"#ff0000"),new Isotope(4,2,2,"Be",10,1,10.0135338,"#ff0000")],[new Isotope(5,2,13,"B",11,0,10.81,"#000000"),new Isotope(5,2,13,"B",10,1,10.01293695,"#000000"),new Isotope(5,2,13,"B",11,1,11.00930536,"#000000")],[new Isotope(6,2,14,"C",12,0,12.011,"#000000"),new Isotope(6,2,14,"C",12,1,12,"#000000"),new Isotope(6,2,14,"C",13,1,13.00335483507,"#000000"),new Isotope(6,2,14,"C",14,1,14.0032419884,"#000000")],[new Isotope(7,2,15,"N",14,0,14.0067,"#007700"),new Isotope(7,2,15,"N",14,1,14.0030740048,"#007700"),new Isotope(7,2,15,"N",15,1,15.0001088982,"#007700")],[new Isotope(8,2,16,"O",16,0,15.999,"#0000aa"),new Isotope(8,2,16,"O",16,1,15.99491461956,"#0000aa"),new Isotope(8,2,16,"O",17,1,16.9991317,"#0000aa"),new Isotope(8,2,16,"O",18,1,17.999161,"#0000aa")],[new Isotope(9,2,17,"F",19,0,18.998403163,"#00ee00")],[new Isotope(10,2,18,"Ne",20,0,20.1797,"#000000"),new Isotope(10,2,18,"Ne",20,1,19.9924401754,"#000000"),new Isotope(10,2,18,"Ne",21,1,20.99384668,"#000000"),new Isotope(10,2,18,"Ne",22,1,21.991385114,"#000000")],[new Isotope(11,3,1,"Na",23,0,22.98976928,"#ff0000"),new Isotope(11,3,1,"Na",22,1,21.9944364,"#ff0000"),new Isotope(11,3,1,"Na",23,1,22.9897692809,"#ff0000")],[new Isotope(12,3,2,"Mg",24,0,24.305,"#ff0000"),new Isotope(12,3,2,"Mg",24,1,23.9850417,"#ff0000"),new Isotope(12,3,2,"Mg",25,1,24.98583692,"#ff0000"),new Isotope(12,3,2,"Mg",26,1,25.982592929,"#ff0000")],[new Isotope(13,3,13,"Al",27,0,26.9815385,"#ff0000"),new Isotope(13,3,13,"Al",26,1,25.98689169,"#ff0000"),new Isotope(13,3,13,"Al",27,1,26.98153863,"#ff0000")],[new Isotope(14,3,14,"Si",28,0,28.085,"#ff0000"),new Isotope(14,3,14,"Si",28,1,27.9769265325,"#ff0000"),new Isotope(14,3,14,"Si",29,1,28.9764947,"#ff0000"),new Isotope(14,3,14,"Si",30,1,29.97377017,"#ff0000"),new Isotope(14,3,14,"Si",32,1,31.97414808,"#ff0000")],[new Isotope(15,3,15,"P",31,0,30.973761998,"#ff0000"),new Isotope(15,3,15,"P",31,1,30.973761998,"#ff0000"),new Isotope(15,3,15,"P",32,1,31.97390727,"#ff0000"),new Isotope(15,3,15,"P",33,1,32.9717255,"#ff0000")],[new Isotope(16,3,16,"S",32,0,32.06,"#ff0000"),new Isotope(16,3,16,"S",32,1,31.972071,"#ff0000"),new Isotope(16,3,16,"S",33,1,32.97145876,"#ff0000"),new Isotope(16,3,16,"S",34,1,33.9678669,"#ff0000"),new Isotope(16,3,16,"S",35,1,34.96903216,"#ff0000"),new Isotope(16,3,16,"S",36,1,35.96708076,"#ff0000")],[new Isotope(17,3,17,"Cl",35,0,35.45,"#00ee00"),new Isotope(17,3,17,"Cl",35,1,34.96885268,"#00ee00"),new Isotope(17,3,17,"Cl",36,1,35.96830698,"#00ee00"),new Isotope(17,3,17,"Cl",37,1,36.96590259,"#00ee00")],[new Isotope(18,3,18,"Ar",40,0,39.948,"#000000"),new Isotope(18,3,18,"Ar",36,1,35.967545106,"#000000"),new Isotope(18,3,18,"Ar",37,1,36.96677632,"#000000"),new Isotope(18,3,18,"Ar",38,1,37.9627324,"#000000"),new Isotope(18,3,18,"Ar",39,1,38.964313,"#000000"),new Isotope(18,3,18,"Ar",40,1,39.9623831225,"#000000"),new Isotope(18,3,18,"Ar",42,1,41.963046,"#000000")],[new Isotope(19,4,1,"K",39,0,39.0983,"#ff0000"),new Isotope(19,4,1,"K",39,1,38.96370649,"#ff0000"),new Isotope(19,4,1,"K",40,1,39.9639982,"#ff0000"),new Isotope(19,4,1,"K",41,1,40.96182526,"#ff0000")],[new Isotope(20,4,2,"Ca",40,0,40.078,"#ff0000"),new Isotope(20,4,2,"Ca",40,1,39.9625909,"#ff0000"),new Isotope(20,4,2,"Ca",41,1,41,"#ff0000"),new Isotope(20,4,2,"Ca",42,1,41.958618,"#ff0000"),new Isotope(20,4,2,"Ca",43,1,42.958766,"#ff0000"),new Isotope(20,4,2,"Ca",44,1,43.955482,"#ff0000"),new Isotope(20,4,2,"Ca",45,1,45,"#ff0000"),new Isotope(20,4,2,"Ca",46,1,45.95369,"#ff0000"),new Isotope(20,4,2,"Ca",47,1,47,"#ff0000"),new Isotope(20,4,2,"Ca",48,1,47.9525228,"#ff0000")],[new Isotope(21,4,3,"Sc",45,0,44.955908,"#000000"),new Isotope(21,4,3,"Sc",45,1,44.955908,"#000000")],[new Isotope(22,4,4,"Ti",48,0,47.867,"#000000")],[new Isotope(23,4,5,"V",51,0,50.9415,"#000000")],[new Isotope(24,4,6,"Cr",52,0,51.9961,"#000000")],[new Isotope(25,4,7,"Mn",55,0,54.938044,"#000000")],[new Isotope(26,4,8,"Fe",56,0,55.845,"#000000")],[new Isotope(27,4,9,"Co",59,0,58.933194,"#000000")],[new Isotope(28,4,10,"Ni",58,0,58.6934,"#000000")],[new Isotope(29,4,11,"Cu",63,0,63.546,"#000000")],[new Isotope(30,4,12,"Zn",64,0,65.38,"#000000")],[new Isotope(31,4,13,"Ga",69,0,69.723,"#000000")],[new Isotope(32,4,14,"Ge",74,0,72.63,"#000000")],[new Isotope(33,4,15,"As",75,0,74.921595,"#000000")],[new Isotope(34,4,16,"Se",80,0,78.971,"#000000")],[new Isotope(35,4,17,"Br",79,0,79.904,"#00ee00")],[new Isotope(36,4,18,"Kr",84,0,83.798,"#000000")],[new Isotope(37,5,1,"Rb",85,0,85.4678,"#ff0000")],[new Isotope(38,5,2,"Sr",88,0,87.62,"#ff0000")],[new Isotope(39,5,3,"Y",89,0,88.90584,"#000000")],[new Isotope(40,5,4,"Zr",90,0,91.224,"#000000")],[new Isotope(41,5,5,"Nb",93,0,92.90637,"#000000")],[new Isotope(42,5,6,"Mo",98,0,95.95,"#000000")],[new Isotope(43,5,7,"Tc",98,0,98.9063,"#000000")],[new Isotope(44,5,8,"Ru",102,0,101.07,"#000000")],[new Isotope(45,5,9,"Rh",103,0,102.9055,"#000000")],[new Isotope(46,5,10,"Pd",106,0,106.42,"#000000")],[new Isotope(47,5,11,"Ag",107,0,107.8682,"#000000")],[new Isotope(48,5,12,"Cd",114,0,112.414,"#000000")],[new Isotope(49,5,13,"In",115,0,114.818,"#000000")],[new Isotope(50,5,14,"Sn",120,0,118.71,"#000000")],[new Isotope(51,5,15,"Sb",121,0,121.76,"#000000")],[new Isotope(52,5,16,"Te",130,0,127.6,"#000000")],[new Isotope(53,5,17,"I",127,0,126.90447,"#00ee00")],[new Isotope(54,5,18,"Xe",132,0,131.293,"#000000")],[new Isotope(55,6,1,"Cs",133,0,132.90545196,"#ff0000")],[new Isotope(56,6,2,"Ba",138,0,137.327,"#ff0000")],[new Isotope(72,6,4,"Hf",180,0,178.49,"#000000")],[new Isotope(73,6,5,"Ta",181,0,180.94788,"#000000")],[new Isotope(74,6,6,"W",184,0,183.84,"#000000")],[new Isotope(75,6,7,"Re",187,0,186.207,"#000000")],[new Isotope(76,6,8,"Os",192,0,190.23,"#000000")],[new Isotope(77,6,9,"Ir",193,0,192.217,"#000000")],[new Isotope(78,6,10,"Pt",195,0,195.084,"#000000")],[new Isotope(79,6,11,"Au",197,0,196.966569,"#000000")],[new Isotope(80,6,12,"Hg",202,0,200.592,"#000000")],[new Isotope(81,6,13,"Tl",205,0,204.38,"#000000")],[new Isotope(82,6,14,"Pb",208,0,207.2,"#000000")],[new Isotope(83,6,15,"Bi",209,0,208.9804,"#000000")],[new Isotope(84,6,16,"Po",210,0,209.98,"#000000")],[new Isotope(85,6,17,"At",210,0,209.9871,"#00ee00")],[new Isotope(86,6,18,"Rn",222,0,222,"#000000")],[new Isotope(87,7,1,"Fr",223,0,223.0197,"#ff0000")],[new Isotope(88,7,2,"Ra",226,0,226.0254,"#ff0000")],[new Isotope(104,7,4,"Rf",261,0,261,"#a0a0a0")],[new Isotope(105,7,5,"Db",262,0,262,"#a0a0a0")],[new Isotope(106,7,6,"Sg",266,0,266,"#a0a0a0")],[new Isotope(107,7,7,"Bh",262,0,262,"#a0a0a0")],[new Isotope(108,7,8,"Hs",270,0,270,"#a0a0a0")],[new Isotope(109,7,9,"Mt",268,0,268,"#a0a0a0")],[new Isotope(110,7,10,"Ds",281,0,281,"#a0a0a0")],[new Isotope(111,7,11,"Rg",280,0,280,"#a0a0a0")],[new Isotope(112,7,12,"Cn",285,0,285,"#a0a0a0")],[new Isotope(113,7,13,"Nh",284,0,284,"#a0a0a0")],[new Isotope(114,7,14,"Fl",285,0,285,"#a0a0a0")],[new Isotope(115,7,15,"Mc",289,0,289,"#a0a0a0")],[new Isotope(116,7,16,"Lv",293,0,293,"#a0a0a0")],[new Isotope(117,7,17,"Ts",294,0,294,"#a0a0a0")],[new Isotope(118,7,18,"Og",294,0,294,"#a0a0a0")],[new Isotope(57,8,3,"La",139,0,138.90547,"#000000")],[new Isotope(58,8,4,"Ce",140,0,140.116,"#000000")],[new Isotope(59,8,5,"Pr",141,0,140.90766,"#000000")],[new Isotope(60,8,6,"Nd",142,0,144.242,"#000000")],[new Isotope(61,8,7,"Pm",147,0,146.9151,"#000000")],[new Isotope(62,8,8,"Sm",152,0,150.36,"#000000")],[new Isotope(63,8,9,"Eu",153,0,151.964,"#000000")],[new Isotope(64,8,10,"Gd",158,0,157.25,"#000000")],[new Isotope(65,8,11,"Tb",159,0,158.92535,"#000000")],[new Isotope(66,8,12,"Dy",164,0,162.5,"#000000")],[new Isotope(67,8,13,"Ho",165,0,164.93033,"#000000")],[new Isotope(68,8,14,"Er",166,0,167.259,"#000000")],[new Isotope(69,8,15,"Tm",169,0,168.93422,"#000000")],[new Isotope(70,8,16,"Yb",174,0,173.045,"#000000")],[new Isotope(71,8,17,"Lu",175,0,174.9668,"#000000")],[new Isotope(89,9,3,"Ac",227,0,227.0278,"#000000")],[new Isotope(90,9,4,"Th",232,0,232.0377,"#000000")],[new Isotope(91,9,5,"Pa",231,0,231.03588,"#000000")],[new Isotope(92,9,6,"U",238,0,238.02891,"#000000")],[new Isotope(93,9,7,"Np",237,0,237.0482,"#000000")],[new Isotope(94,9,8,"Pu",244,0,244.0642,"#000000")],[new Isotope(95,9,9,"Am",243,0,243.061375,"#000000")],[new Isotope(96,9,10,"Cm",247,0,247.0703,"#000000")],[new Isotope(97,9,11,"Bk",247,0,247,"#000000")],[new Isotope(98,9,12,"Cf",251,0,251,"#000000")],[new Isotope(99,9,13,"Es",252,0,252,"#000000")],[new Isotope(100,9,14,"Fm",257,0,257.0951,"#000000")],[new Isotope(101,9,15,"Md",258,0,258,"#000000")],[new Isotope(102,9,16,"No",259,0,259,"#000000")],[new Isotope(103,9,17,"Lr",266,0,266,"#000000")]],this.elementsByName={},this.elementsByName.D=this.elements[0][2],this.elementsByName.T=this.elements[0][3];for(var t=0;t<this.elements.length;t++){var e=this.elements[t][0];this.elementsByName[e.getSymbol()]=e}this.getElement=function(t){return this.elementsByName[t.trim()]}}function EraserTool(t,e){this.id="eraser",this.context=t,this.distMax=e.distMax,this.abort=function(){Tools.abort(this)},this.eraseAtom=function(t){var e=new ActionList,o=this.context.molecule.getAtom(t);for(var i in o.bonds){var s=this.context.molecule.getBond(i);e.addAction(new Action("DEL","BOND",null,s)),this.context.molecule.delBond(s)}e.addAction(new Action("DEL","ATOM",null,o)),this.context.molecule.delAtom(o),this.context.history.appendAction(e),this.context.draw()},this.eraseBond=function(t){var e=new ActionList,o=this.context.molecule.getBond(t),i=o.atomA,s=o.atomB;e.addAction(new Action("DEL","BOND",null,o)),this.context.molecule.delBond(o),0==Object.keys(i.bonds).length&&(e.addAction(new Action("DEL","ATOM",null,i)),this.context.molecule.delAtom(i)),0==Object.keys(s.bonds).length&&(e.addAction(new Action("DEL","ATOM",null,s)),this.context.molecule.delAtom(s)),this.context.history.appendAction(e),this.context.draw()},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectBond(i,this.distMax);if(1==s.length)this.eraseBond(s[0]);else{var n=this.context.molecule.selectAtom(i,this.distMax);null!=n&&this.eraseAtom(n)}},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){}}function History(t,e){this.actions=[],this.actionPtr=-1,this.contextId=t,this.installPath=e.installPath,this.appendAction=function(t){this.actionPtr++,this.actions[this.actionPtr]=t,this.actions.splice(this.actionPtr+1,this.actions.length-this.actionPtr-1),this.updateIcons()},this.updateIcons=function(){var t=document.getElementById(this.contextId+"_redo");this.actionPtr<this.actions.length-1?t.src=this.installPath+"img/redo.png":t.src=this.installPath+"img/redo_inactive.png",t=document.getElementById(this.contextId+"_undo"),this.actionPtr>-1?t.src=this.installPath+"img/undo.png":t.src=this.installPath+"img/undo_inactive.png"},this.redo=function(t){if(!(this.actionPtr>this.actions.length-2)){this.actionPtr++;for(var e=this.actions[this.actionPtr],o=e.actions.length;o-- >0;){var i=e.actions[o];switch(i.actionType){case"ADD":this.redoAdd(t,i);break;case"DEL":this.redoDelete(t,i);break;case"UPD":this.redoUpdate(t,i);break;default:alert("Unknown actionType "+o.actionType+" of action in History.redo().")}}this.updateIcons()}},this.redoAdd=function(t,e){switch(e.objectType){case"ATOM":t.molecule.addAtom(e.newObject,e.newObject.id);break;case"BOND":t.molecule.addBond(e.newObject,e.newObject.id);break;default:alert("Unknown objectType "+e.objectType+" in History.redoAdd().")}},this.redoDelete=function(t,e){switch(e.objectType){case"ATOM":t.molecule.delAtom(e.oldObject);break;case"BOND":t.molecule.delBond(e.oldObject);break;default:alert("Unknown objectType "+e.objectType+" in History.redoDelete().")}},this.redoUpdate=function(t,e){switch(e.objectType){case"ATOM":t.molecule.replaceAtom(e.newObject);break;case"BOND":t.molecule.replaceBond(e.newObject);break;default:alert("Unknown objectType "+e.objectType+" in History.redoUpdate().")}},this.undo=function(t){if(!(this.actionPtr<0)){var e=this.actions[this.actionPtr];for(var o in e.actions){var i=e.actions[o];switch(i.actionType){case"ADD":this.undoAdd(t,i);break;case"DEL":this.undoDelete(t,i);break;case"UPD":this.undoUpdate(t,i);break;default:alert("Unknown actionType "+o.actionType+" of action in History.undo().")}}this.actionPtr--,this.updateIcons()}},this.undoAdd=function(t,e){switch(e.objectType){case"ATOM":t.molecule.delAtom(e.newObject);break;case"BOND":t.molecule.delBond(e.newObject);break;default:alert("Unknown objectType "+e.objectType+" in History.undoAdd().")}},this.undoDelete=function(t,e){switch(e.objectType){case"ATOM":t.molecule.addAtom(e.oldObject,e.oldObject.id);break;case"BOND":t.molecule.addBond(e.oldObject,e.oldObject.id);break;default:alert("Unknown objectType "+e.objectType+" in History.undoDelete().")}},this.undoUpdate=function(t,e){switch(e.objectType){case"ATOM":t.molecule.replaceAtom(e.oldObject);break;case"BOND":t.molecule.replaceBond(e.oldObject);break;default:alert("Unknown objectType "+e.objectType+" in History.undoUpdate().")}}}function Isotope(t,e,o,i,s,n,r,a){this.atomicNumber=t,this.color=a,this.group=o,this.isotope=n,this.mass=s,this.massExact=r,this.period=e,this.symbol=i,this.getAtomicNumber=function(){return this.atomicNumber},this.getColor=function(){return this.color},this.getGroup=function(){return this.group},this.getIsotope=function(){return this.isotope},this.getMass=function(){return this.mass},this.getMassExact=function(){return this.massExact},this.getPeriod=function(){return this.period},this.getSymbol=function(){return this.symbol}}function IsotopeTool(t,e){this.id="isotope",this.context=t,this.distMax=e.distMax,this.type="isotope_up",this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);if(null!=s){var n=new ActionList,r=this.context.molecule.getAtom(s),a=r.copy(),c="isotope_up"==this.type?1:-1;r.changeIsotope(c),this.context.molecule.replaceAtom(r),n.addAction(new Action("UPD","ATOM",r,a)),this.context.history.appendAction(n)}this.context.draw()},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){},this.setType=function(t){this.type=t},this.setup=function(){var t=this.context.contextId+"_"+this.type,e=this.context.contextId+"_isotope";icon=document.getElementById(e),icon.src=document.getElementById(t).src}}function MDLv2000Reader(t){this.molString=t,this.currentIndex=0,this.molecule=new Molecule,this.isoProp=0,this.chgProp=0,this.getLine=function(){var t=this.currentIndex;if(this.molString.length<=t)return null;var e=this.molString.substr(this.currentIndex).indexOf("\n");return e>-1?(this.currentIndex+=e+1,this.molString.substr(t,e)):(this.currentIndex=this.molString.length,this.molString.substr(t))},this.getMolecule=function(){return this.molecule},this.parseAtom=function(t){var e=new Atom;e.coordX=parseFloat(t.substr(0,10)),e.coordY=-1*parseFloat(t.substr(10,10)),e.coordZ=parseFloat(t.substr(20,10));var o=Elements.instance.getElement(t.substr(31,3)),i=new AtomType;return i.setIsotope(o),i.setColor(o.getColor()),e.setType(i),this.parseAtomMassDiff(e,parseInt(t.substr(34,2))),this.parseAtomLineCharge(e,parseInt(t.substr(36,3))),e},this.parseAtomLineCharge=function(t,e){switch(this.chgProp=1,e){case 0:t.setCharge(0);break;case 1:t.setCharge(3);break;case 2:t.setCharge(2);break;case 3:t.setCharge(1);break;case 4:t.setCharge(0),t.setRadical(2);break;case 5:t.setCharge(-1);break;case 6:t.setCharge(-2);break;case 7:t.setCharge(-3);break;default:alert("Illegal value for charge in atom line: "+e)}},this.parseAtomMassDiff=function(t,e){if(this.isoProp=1,0!==e){var o=t.getType().getIsotope().getAtomicNumber()-1,i=t.getType().getIsotope().getMass();for(var s of Elements.instance.elements[o])if(s.getIsotope()>0&&s.getMass()==i+e){var n=new AtomType;n.setIsotope(s),n.setColor(s.getColor()),t.setType(n);break}}},this.parseBond=function(t){var e=new Bond,o="Atom"+t.substr(0,3).trim();return e.setAtomA(this.molecule.getAtom(o)),o="Atom"+t.substr(3,3).trim(),e.setAtomB(this.molecule.getAtom(o)),e.setType(t.substr(6,3).trim()),e.setStereo(t.substr(9,3).trim()),e},this.parseCharge=function(t){this.chgProp>0&&this.resetCharges();for(var e=parseInt(t.substr(6,3).trim()),o=9;e>0;){var i="Atom"+t.substr(o,4).trim(),s=parseInt(t.substr(o+4,4).trim());this.molecule.getAtom(i).setCharge(s),o+=8,e--}},this.parseIsotope=function(t){this.isoProp>0&&this.resetIsotopes();for(var e=parseInt(t.substr(6,3).trim()),o=9;e>0;){var i="Atom"+t.substr(o,4).trim(),s=parseInt(t.substr(o+4,4).trim()),n=this.molecule.getAtom(i).getType().getIsotope().getAtomicNumber()-1;for(var r of Elements.instance.elements[n])if(r.getIsotope()>0&&r.getMass()==s){var a=new AtomType;a.setIsotope(r),a.setColor(r.getColor()),this.molecule.getAtom(i).setType(a);break}o+=8,e--}},this.parseProperty=function(t){switch(t.substr(0,6)){case"M  CHG":this.parseCharge(t);break;case"M  ISO":this.parseIsotope(t);break;case"M  RAD":this.parseRadical(t)}},this.parseRadical=function(t){this.chgProp>0&&this.resetCharges();for(var e=parseInt(t.substr(6,3).trim()),o=9;e>0;){var i="Atom"+t.substr(o,4).trim(),s=parseInt(t.substr(o+4,4).trim());this.molecule.getAtom(i).setRadical(s),o+=8,e--}},this.read=function(){for(var t=0,e=0,o=0,i=0,s=0,n=0,r=this.getLine();null!=r;){switch(n){case 0:this.molecule.setProperty("NAME",r),n++;break;case 1:this.molecule.setProperty("HEADER2",r),n++;break;case 2:this.molecule.setProperty("COMMENT",r),n++;break;case 3:e=parseInt(r.substr(0,3)),o=parseInt(r.substr(3,3)),i=parseInt(r.substr(6,3)),s=parseInt(r.substr(15,3)),n++;break;case 4:if(t!=e){this.molecule.addAtom(this.parseAtom(r),null),t++;break}t=0,n++;case 5:if(t!=o){this.molecule.addBond(this.parseBond(r),null),t++;break}t=0,n++;case 6:if(i>0){if(t!=i){t++;break}t=0,n++}else n++;case 7:if(s>0){if(t!=s){t++;break}t=0,n++}else n++;default:this.parseProperty(r),t++}r=this.getLine()}},this.resetCharges=function(){for(var t in this.molecule.getAtoms()){var e=this.molecule.getAtom(t);e.setCharge(0),e.setRadical(0)}this.chgProp=0},this.resetIsotopes=function(){for(var t in this.molecule.getAtoms()){var e=this.molecule.getAtom(t);if(e.getType().getIsotope().getIsotope()>0){var o=e.getType().getIsotope().getAtomicNumber()-1,i=new AtomType;i.setIsotope(Elements.instance.elements[o][0]),i.setColor(i.getIsotope().getColor()),e.setType(i)}}}}function MDLv2000Writer(){this.write=function(t){var e="";return t.reIndex(),e+=t.getProperty("NAME")+"\n",e+=t.getProperty("HEADER2")+"\n",e+=t.getProperty("COMMENT")+"\n",e+=sprintf("%3d%3d  0  0  0  0            999\n",t.getAtomCount(),t.getBondCount()),e+=this.writeAtomTable(t),e+=this.writeBondTable(t),e+=this.writeProperties(t),e+="M  END\n"},this.atomLineCharge=function(t){switch(t.getCharge()){case 1:return 3;case 2:return 2;case 3:return 1;case-1:return 5;case-2:return 6;case-3:return 7}return 2==t.getRadical()?4:0},this.writeAtomTable=function(t){var e="";for(var o in t.getAtoms()){var i=t.getAtom(o),s=i.getType().getIsotope().getSymbol()+"  ";e+=sprintf("%10.4f%10.4f%10.4f %3s%2d%3d%3d%3d%3d%3d%3d%3d%3d%3d%3d%3d\n",i.coordX,-1*i.coordY,i.coordZ,s.substring(0,3),0,this.atomLineCharge(i),0,0,0,0,0,0,0,0,0,0)}return e},this.writeBondTable=function(t){var e="";for(var o in t.getBonds()){var i=t.getBond(o);e+=sprintf("%3d%3d%3d%3d\n",i.getAtomA().getIndex(),i.getAtomB().getIndex(),i.getType(),i.getStereo())}return e},this.writeCharges=function(t){var e,o="",i=[],s=[];for(var n in t.getAtoms()){var r=t.getAtom(n);0!=r.getCharge()&&(i.push(r.getIndex()),s.push(r.getCharge()))}for(var a=0;a<i.length;a++)a%8==0&&(a>0&&(o+="\n"),e=(e=i.length-a)>8?8:e,o+=sprintf("M  CHG%3d",e)),o+=sprintf(" %3d %3d",i[a],s[a]),a==i.length-1&&(o+="\n");return o},this.writeIsotopes=function(t){var e,o="",i=[],s=[];for(var n in t.getAtoms()){var r=t.getAtom(n);r.getType().getIsotope().getIsotope()>0&&(i.push(r.getIndex()),s.push(r.getType().getIsotope().getMass()))}for(var a=0;a<i.length;a++)a%8==0&&(a>0&&(o+="\n"),e=(e=i.length-a)>8?8:e,o+=sprintf("M  ISO%3d",e)),o+=sprintf(" %3d %3d",i[a],s[a]),a==i.length-1&&(o+="\n");return o},this.writeProperties=function(t){var e="";return e+=this.writeCharges(t),e+=this.writeRadicals(t),e+=this.writeIsotopes(t)},this.writeRadicals=function(t){var e,o="",i=[],s=[];for(var n in t.getAtoms()){var r=t.getAtom(n);0!=r.getRadical()&&(i.push(r.getIndex()),s.push(r.getRadical()))}for(var a=0;a<i.length;a++)a%8==0&&(a>0&&(o+="\n"),e=(e=i.length-a)>8?8:e,o+=sprintf("M  RAD%3d",e)),o+=sprintf(" %3d %3d",i[a],s[a]),a==i.length-1&&(o+="\n");return o}}function Molecule(){this.properties={},this.properties.COMMENT="generated by MolPaintJS",this.properties.HEADER2="",this.properties.NAME="n.n.",this.atoms={},this.bonds={},this.sgroups={},this.atomCount=0,this.bondCount=0,this.atomObjCount=0,this.bondObjCount=0,this.sgroupObjCount=0,this.addAtom=function(t,e){return this.atomObjCount++,null==e&&(e="Atom"+this.atomObjCount,t.setId(e)),this.atoms[e]=t,e},this.addBond=function(t,e){return this.bondObjCount++,null==e&&(e="Bond"+this.bondObjCount,t.setId(e)),this.bonds[e]=t,t.atomA.addBond(e),t.atomB.addBond(e),e},this.addSGroup=function(t,e){return this.sgroupObjCount++,null==e&&(e="SGroup"+this.sgroupObjCount,t.setId(e)),this.sgroups[e]=t,e},this.adjustSelection=function(t,e,o){for(var i in this.atoms)this.atoms[i].selected&t&&(this.atoms[i].selected&=~e,this.atoms[i].selected|=o);for(var i in this.bonds)this.bonds[i].selected&t&&(this.bonds[i].selected&=~e,this.bonds[i].selected|=o)},this.center=function(){var t=this.computeBBox(0);for(var e in this.atoms)this.atoms[e].coordX-=t.centerX,this.atoms[e].coordY-=t.centerY;return t.minX-=t.centerX,t.maxX-=t.centerX,t.minY-=t.centerY,t.maxY-=t.centerY,t.centerX=0,t.centerY=0,t},this.clearSelection=function(t){for(var e in this.atoms)this.atoms[e].selected&t&&(this.atoms[e].selected&=~t);for(var e in this.bonds)this.bonds[e].selected&t&&(this.bonds[e].selected&=~t)},this.clearTemp=function(){var t=new ActionList;for(var e in this.atoms)this.atoms[e].temp&&(this.atoms[e].temp=0,t.addAction(new Action("ADD","ATOM",this.atoms[e],null)));for(var e in this.bonds)this.bonds[e].temp&&(this.bonds[e].temp=0,t.addAction(new Action("ADD","BOND",this.bonds[e],null)));return t},this.computeBBox=function(t){var e={centerX:0,centerY:0,centerZ:0,maxX:0,maxY:0,maxZ:0,minX:0,minY:0,minZ:0},o=0;for(var i in this.atoms){var s=this.atoms[i];if(0===t||0!=(s.selected&t)){var n=s.coordX,r=s.coordY,a=s.coordZ;0==o?(e.maxX=n,e.minX=n,e.maxY=r,e.minY=r,e.maxZ=a,e.minZ=a,o=1):(e.minX=e.minX>n?n:e.minX,e.minY=e.minY>r?r:e.minY,e.minZ=e.minZ>a?a:e.minZ,e.maxX=e.maxX<n?n:e.maxX,e.maxY=e.maxY<r?r:e.maxY,e.maxZ=e.maxZ<a?a:e.maxZ)}}var c=e.maxX-e.minX;return e.centerX=e.minX+c/2,c=e.maxY-e.minY,e.centerY=e.minY+c/2,c=e.maxZ-e.minZ,e.centerZ=e.minZ+c/2,e},this.computeBondLengths=function(){var t=[];for(var e in this.bonds){var o=this.bonds[e],i=o.atomA.coordX-o.atomB.coordX,s=o.atomA.coordY-o.atomB.coordY,n=i*i+s*s;t.push(n)}return t.sort(function(t,e){return t-e}),t.length>0?Math.sqrt(t[Math.floor(t.length/2)]):1.5},this.delAtom=function(t){var e=t.id;delete this.atoms[e]},this.delBond=function(t){var e=t.id;(t=this.bonds[e]).atomA.delBond(e),t.atomB.delBond(e),delete this.bonds[e]},this.delSGroup=function(t){var e=t.id;delete this.sgroups[e]},this.delTemp=function(){for(var t in this.bonds)this.bonds[t].temp&&(this.bonds[t].atomA.delBond(t),this.bonds[t].atomB.delBond(t),delete this.bonds[t]);for(var e in this.atoms)this.atoms[e].temp&&delete this.atoms[e]},this.getAtom=function(t){return this.atoms[t]},this.getAtomCount=function(){return this.atomCount},this.getAtoms=function(){return this.atoms},this.getBond=function(t){return this.bonds[t]},this.getBondCount=function(){return this.bondCount},this.getBonds=function(){return this.bonds},this.getProperties=function(){return this.properties},this.getProperty=function(t){return this.properties[t]},this.getSelected=function(t){var e={atoms:[],bonds:[]};for(var o in this.atoms)0!=(this.atoms[o].selected&t)&&e.atoms.push(o);for(var o in this.bonds)0!=(this.bonds[o].selected&t)&&e.bonds.push(o);return e},this.reIndex=function(){var t=1;for(var e in this.atoms){this.atoms[e].setIndex(t),t++}for(var e in this.atomCount=t-1,t=1,this.bonds){this.bonds[e].setIndex(t),t++}this.bondCount=t-1},this.replaceAtom=function(t){var e=t.getId(),o=this.atoms[e];if(null!=o){for(var i in o.bonds){var s=this.bonds[i];s.atomA.getId()==e?s.atomA=t:s.atomB=t}this.atoms[e]=t}else alert("Molecule.replaceAtom() called for non-existing atom.")},this.replaceBond=function(t){var e=t.getId();null!=this.bonds[e]?this.bonds[e]=t:alert("Molecule.replaceBond() called for non-existing bond.")},this.selectAtom=function(t,e){for(var o in this.atoms){var i=this.atoms[o],s=i.coordX-t.x,n=i.coordY-t.y;if(e>s*s+n*n)return o}return null},this.selectBBox=function(t,e,o){var i={atoms:[],bonds:[]};for(var s in this.atoms){var n=this.atoms[s];if(0==(n.selected&o)){var r=n.coordX,a=n.coordY;t.minX<r&&r<t.maxX&&t.minY<a&&a<t.maxY&&(n.selected|=e,i.atoms.push(s))}}for(var s in this.bonds){var c=this.bonds[s];if(0==(c.selected&o)){var h=c.atomA,l=c.atomB,d=h.coordX,u=l.coordX,m=h.coordY,p=l.coordY;t.minX<d&&d<t.maxX&&t.minY<m&&m<t.maxY&&t.minX<u&&u<t.maxX&&t.minY<p&&p<t.maxY&&(c.selected|=e,i.bonds.push(s))}}return i},this.selectBond=function(t,e){var o=[];for(var i in this.bonds){var s=this.bonds[i],n=s.atomA.coordX-s.atomB.coordX,r=s.atomA.coordY-s.atomB.coordY,a=Math.sqrt(n*n+r*r);a=a<.01?1:a;var c=t.x-s.atomB.coordX,h=t.y-s.atomB.coordY,l=r/a,d=n/a,u=c*d+h*l,m=-c*l+h*d;u>0&&u<a&&m*m<e&&o.push(i)}return o},this.setProperty=function(t,e){this.properties[t]=e},this.transform=function(t,e){for(var o in this.atoms){var i=this.atoms[o];if(0===e||0!=(i.selected&e)){var s=i.coordX,n=i.coordY;i.coordX=t[0][0]*s+t[0][1]*n+t[0][2],i.coordY=t[1][0]*s+t[1][1]*n+t[1][2]}}}}function NullTool(t){this.id="nullTool",this.context=t,this.imgData=null,this.originX=null,this.originY=null,this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){}}function PointerTool(t,e){this.id="pointer",this.context=t,this.distMax=e.distMax,this.origin=null,this.mode=0,this.actionList=null,this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){if(this.origin=null,0==this.mode)o.ctrlKey?this.context.molecule.adjustSelection(1,3,0):this.context.molecule.adjustSelection(1,1,2);else{for(var i of this.actionList.getActions()){var s=i.oldObject.getId();i.newObject=this.context.molecule.getAtom(s).copy()}this.context.history.appendAction(this.actionList),this.actionList=null}this.context.draw()},this.onMouseDown=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);if(null==s||0==(2&this.context.molecule.getAtom(s).getSelected()))this.mode=0,o.shiftKey||o.ctrlKey?this.context.molecule.clearSelection(1):this.context.molecule.clearSelection(3);else{this.actionList=new ActionList;var n=this.context.molecule.getSelected(2);for(var r of n.atoms){var a=this.context.molecule.getAtom(r);this.actionList.addAction(new Action("UPD","ATOM",null,a.copy()))}o.shiftKey?this.mode=2:this.mode=1}this.context.draw(),this.origin={x:t,y:e}},this.onMouseMove=function(t,e,o){if(null!=this.origin)switch(this.mode){case 0:this.onMouseMoveSelect(t,e,o);break;case 1:this.onMouseMoveTranslate(t,e,o);break;case 2:this.onMouseMoveRotate(t,e,o)}},this.onMouseMoveSelect=function(t,e,o){var i=this.context.view.getContext(),s=new Box(this.origin.x,this.origin.y,t,e),n=this.context.view.getBBoxReverse(s);this.context.molecule.clearSelection(1),this.context.molecule.selectBBox(n,1,0),this.context.draw(),s.draw(i)},this.onMouseMoveRotate=function(t,e,o){var i=t-this.origin.x,s=Math.sin(i/57),n=Math.cos(i/57);this.origin={x:t,y:e},this.context.molecule.transform([[n,s,0],[-1*s,n,0]],2),this.context.draw()},this.onMouseMoveTranslate=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.view.getCoordReverse(this.origin.x,this.origin.y),n=i.x-s.x,r=i.y-s.y;this.origin={x:t,y:e},this.context.molecule.transform([[1,0,n],[0,1,r]],2),this.context.draw()}}function Promise(t){var e,o,i="pending";function s(t){"pending"!==i?t(e):o=t}this.then=function(t){s(t)},t(function(t){e=t,i="resolved",o&&s(o)})}function RadicalTool(t,e){this.id="radical",this.context=t,this.distMax=e.distMax,this.type="radical",this.abort=function(){Tools.abort(this)},this.getType=function(){return this.type},this.onClick=function(t,e,o){var i=this.context.view.getCoordReverse(t,e),s=this.context.molecule.selectAtom(i,this.distMax);if(null!=s){var n=new ActionList,r=this.context.molecule.getAtom(s),a=r.copy();this.type;switch(this.type){case"singlet":r.setRadical(1);break;case"doublet":r.setRadical(2);break;case"triplet":r.setRadical(3);break;case"no_radical":r.setRadical(0)}this.context.molecule.replaceAtom(r),n.addAction(new Action("UPD","ATOM",r,a)),this.context.history.appendAction(n)}this.context.draw()},this.onMouseDown=function(t,e,o){},this.onMouseMove=function(t,e,o){},this.setType=function(t){this.type=t},this.setup=function(){var t=this.context.contextId+"_"+this.type,e=this.context.contextId+"_radical";icon=document.getElementById(e),icon.src=document.getElementById(t).src}}function SGroup(t){this.type=t,this.atoms={},this.bonds={},this.bondVector=[],this.bracketCoordinates=[],this.data=[],this.dataBuffer="",this.dataDisplay=[],this.subscript=null,this.uniqueLabel=null,this.addAtom=function(t){this.atoms[t]=t},this.addBond=function(t){this.bonds[t]=t},this.setBondVector=function(t,e,o){this.bondVector={idx:t,x:e,y:o}},this.setBracketCoordinates=function(t,e,o,i){this.bracketCoordinates.push([t,e,o,i])},this.addData=function(t){this.buffer+=t},this.setData=function(t){b=this.buffer+t,this.buffer="",this.data.push(b.substr(0,200))},this.setDataDisplay=function(t){this.dataDisplay.push(t)},this.setSubscript=function(t){this.subscript=t},this.setUniqueLabel=function(t){this.uniqueLabel=t}}function SlideTool(t){this.id="slide",this.context=t,this.origin=null,this.abort=function(){Tools.abort(this)},this.onClick=function(t,e,o){this.origin=null,this.context.draw()},this.onMouseDown=function(t,e,o){this.origin={x:t,y:e}},this.onMouseMove=function(t,e,o){if(null!=this.origin){var i=t-this.origin.x,s=e-this.origin.y;this.origin={x:t,y:e},this.context.view.slide(i,s),this.context.draw()}}}function TemplateTool(t,e,o){this.actionList=null,this.context=t,this.properties=e,this.id=o,this.template="",this.templateId="",this.origin=null,this.abort=function(){Tools.abort(this)},this.joinAtoms=function(t,e){var o=t.id;e.id;for(var i in t.bonds){var s=null,n=null;if(this.context.molecule.bonds[i].atomA.id==o)0==(2&(s=this.context.molecule.bonds[i].atomB).selected)&&((n=new Bond).setAtomA(e),n.setAtomB(s),n.setType(this.context.molecule.bonds[i].getType()),n.setStereo(this.context.molecule.bonds[i].getStereo()));else 0==(2&(s=this.context.molecule.bonds[i].atomA).selected)&&((n=new Bond).setAtomA(s),n.setAtomB(e),n.setType(this.context.molecule.bonds[i].getType()),n.setStereo(this.context.molecule.bonds[i].getStereo()));null!=n&&(this.actionList.addAction(new Action("ADD","BOND",n,null)),this.context.molecule.addBond(n,null)),n=this.context.molecule.bonds[i],this.actionList.addAction(new Action("DEL","BOND",null,n)),this.context.molecule.delBond(n)}this.actionList.addAction(new Action("DEL","ATOM",null,t)),this.context.molecule.delAtom(t)},this.onClick=function(t,o,i){this.origin=null,this.context.molecule.adjustSelection(2,2,0);var s=this.context.molecule.computeBBox(1),n=this.context.molecule.selectBBox(s,2,1),r=this.context.molecule.getSelected(1);for(var a of n.atoms)for(var c of r.atoms){var h=this.context.molecule.getAtom(a),l=this.context.molecule.getAtom(c),d=h.coordX-l.coordX,u=h.coordY-l.coordY;if(e.distMax>d*d+u*u){this.joinAtoms(h,l);break}}this.context.molecule.clearSelection(3),this.context.draw()},this.onMouseDown=function(t,e,o){this.origin=this.context.view.getCoordReverse(t,e),this.actionList=this.context.pasteMolecule(this.template,1),this.context.molecule.transform([[1,0,this.origin.x],[0,1,this.origin.y]],!0),this.context.draw()},this.onMouseMove=function(t,e,o){if(null!=this.origin){var i=this.context.view.getCoordReverse(t,e),s=i.x-this.origin.x,n=i.y-this.origin.y;this.origin=i,this.context.molecule.transform([[1,0,s],[0,1,n]],1),this.context.molecule.adjustSelection(2,2,0);var r=this.context.molecule.computeBBox(1);this.context.molecule.selectBBox(r,2,1),this.context.draw()}},this.setTemplate=function(t,e){this.templateId=t,this.template=e},this.setup=function(){var t=this.context.contextId+"_"+this.templateId,e=this.context.contextId+"_template";icon=document.getElementById(e),icon.src=document.getElementById(t).src}}function Tools(){}function View(t,e){this.displayScale=1,this.fontFamily=e.fontFamily,this.fontSize=e.fontSize,this.molScale=e.molScaleDefault,this.sizeX=e.sizeX,this.sizeY=e.sizeY,this.subscriptFactor=e.subscriptFactor,this.centerX=this.sizeX/2,this.centerY=this.sizeY/2,this.contextId=t+"_canvas",this.context=null,this.element=null,this.center=function(){this.centerX=this.sizeX/2,this.centerY=this.sizeY/2},this.getBBox=function(t){return new Box(t.minX*this.molScale*this.displayScale+this.centerX,t.minY*this.molScale*this.displayScale+this.centerY,t.maxX*this.molScale*this.displayScale+this.centerX,t.maxY*this.molScale*this.displayScale+this.centerY)},this.getBBoxReverse=function(t){return new Box((t.minX-this.centerX)/(this.molScale*this.displayScale),(t.minY-this.centerY)/(this.molScale*this.displayScale),(t.maxX-this.centerX)/(this.molScale*this.displayScale),(t.maxY-this.centerY)/(this.molScale*this.displayScale))},this.getContext=function(){return this.context},this.getCoord=function(t){return{x:this.centerX+t.coordX*this.molScale*this.displayScale,y:this.centerY+t.coordY*this.molScale*this.displayScale}},this.getCoordReverse=function(t,e){return{x:(t-this.centerX)/(this.molScale*this.displayScale),y:(e-this.centerY)/(this.molScale*this.displayScale)}},this.getElement=function(){return this.element},this.getFontSize=function(){return this.fontSize},this.getSubscriptSize=function(){return this.fontSize*this.subscriptFactor},this.getOffset=function(){var t=this.element.getBoundingClientRect();return{x:t.left,y:t.top}},this.getSizeX=function(){return this.sizeX},this.getSizeY=function(){return this.sizeY},this.init=function(){this.element=document.getElementById(this.contextId),this.context=this.element.getContext("2d"),this.context.font=this.fontSize+"px "+this.fontFamily},this.scaleFontSize=function(t){this.fontSize*=t,this.context.font=this.fontSize+"px "+this.fontFamily},this.setFont=function(){this.context.font=this.fontSize+"px "+this.fontFamily},this.setFontSize=function(t){this.fontSize=t,this.context.font=t+"px "+this.fontFamily},this.setMolScale=function(t){this.molScale=t},this.setSubscript=function(){var t=this.fontSize*this.subscriptFactor;this.context.font=t+"px "+this.fontFamily},this.slide=function(t,e){this.centerX+=t,this.centerY+=e}}function Widget(t,e,o){this.distMax=e.distMax,this.molpaint=o,this.iconSize=e.iconSize,this.installPath=e.installPath,this.height=e.sizeY,this.widgetId=t,this.widgetObject=document.getElementById(t),this.width=e.sizeX,this.viewer=1===e.viewer,this.actionCarbon=function(t){var e=contextRegistry[t.target.id];e.currentElement=Elements.instance.getElement("C"),e.setCurrentTool(e.tools.carbonAtomTool)},this.actionCenter=function(t){var e=contextRegistry[t.target.id];e.view.center(),e.draw()},this.actionChain=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.chainTool)},this.actionChargeDec=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.chargeDecTool)},this.actionChargeInc=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.chargeIncTool)},this.actionCopy=function(t){var e=contextRegistry[t.target.id],o=new MDLv2000Writer,i=document.createElement("textarea");document.body.appendChild(i),i.setAttribute("id",t.target.id+"dummyId"),document.getElementById(t.target.id+"dummyId").value=o.write(e.molecule),i.select(),document.execCommand("copy"),document.body.removeChild(i)},this.actionClear=function(t){var e=t.target.id,o=contextRegistry[e],i=new ActionList;for(var s in o.molecule.getAtoms())i.addAction(new Action("DEL","ATOM",null,o.molecule.getAtom(s)));for(var n in o.molecule.getBonds())i.addAction(new Action("DEL","BOND",null,o.molecule.getBond(n)));o.history.appendAction(i),o.molecule=new Molecule,o.draw()},this.actionCustomElement=function(t){var e=contextRegistry[t.target.id];switch(e.currentElement.getSymbol()){case"H":e.setCurrentTool(e.tools.hydrogenAtomTool);break;case"C":e.setCurrentTool(e.tools.carbonAtomTool);break;case"N":e.setCurrentTool(e.tools.nitrogenAtomTool);break;case"O":e.setCurrentTool(e.tools.oxygenAtomTool);break;default:e.setCurrentTool(e.tools.customElementTool)}},this.actionEraser=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.eraserTool)},this.actionDoubleBond=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.doubleBondTool)},this.actionHashedWedge=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.hashedWedgeTool)},this.actionHydrogen=function(t){var e=contextRegistry[t.target.id];e.currentElement=Elements.instance.getElement("H"),e.setCurrentTool(e.tools.hydrogenAtomTool)},this.actionInfo=function(t){var e=contextRegistry[t.target.id];window.open(e.properties.installPath+"help/index.html")},this.actionIsotope=function(t){var e=contextRegistry[t.target.id],o=e.tools.isotopeTool,i=t.target.id.replace(e.contextId+"_","");"isotope"!=i&&o.setType(i),e.setCurrentTool(o)},this.actionNitrogen=function(t){var e=contextRegistry[t.target.id];e.currentElement=Elements.instance.getElement("N"),e.setCurrentTool(e.tools.nitrogenAtomTool)},this.actionOxygen=function(t){var e=contextRegistry[t.target.id];e.currentElement=Elements.instance.getElement("O"),e.setCurrentTool(e.tools.oxygenAtomTool)},this.actionPaste=function(t){var e=contextRegistry[t.currentTarget.id];t.stopPropagation(),t.preventDefault();var o=t.clipboardData||window.clipboardData;null==o&&alert("Clipboard not supported in this browser.\nYou might want to try the paste icon");var i=o.getData("text");e.pasteMolecule(i,2)},this.actionPasteButton=function(t){try{var e=contextRegistry[t.target.id];(new AllowClipboard.Client.ClipboardClient).read(function(t,o){e.pasteMolecule(o)})}catch(t){console.log(t.message),alert("In Chrome, please install the 'AllowClipboard' extension.\nIn other browsers, please try Ctrl+V in the drawing area.")}},this.actionPointer=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.pointerTool)},this.actionRadical=function(t){var e=contextRegistry[t.target.id],o=e.tools.radicalTool;e.setCurrentTool(o);var i=t.target.id.replace(e.contextId+"_","");"radical"!=i&&o.setType(i),"radical"!=o.getType()&&e.setCurrentTool(o)},this.actionRedo=function(t){var e=contextRegistry[t.target.id];e.history.redo(e),e.draw()},this.actionSingleBond=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.singleBondTool)},this.actionSlide=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.slideTool)},this.actionSolidWedge=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.solidWedgeTool)},this.actionTemplate=function(t){var e=contextRegistry[t.target.id],o=e.tools.templateTool,i=t.target.id.replace(e.contextId+"_","");"template"==i?i=e.currentTemplate:e.currentTemplate=i,o.setTemplate(i,e.molpaint.getTemplate(i)),e.setCurrentTool(o)},this.actionTripleBond=function(t){var e=contextRegistry[t.target.id];e.setCurrentTool(e.tools.tripleBondTool)},this.actionUndo=function(t){var e=contextRegistry[t.target.id];e.history.undo(e),e.draw()},this.actionZoomIn=function(t){var e=contextRegistry[t.target.id];e.view.displayScale*=1.5,e.view.scaleFontSize(1.5),e.draw()},this.actionZoomOut=function(t){var e=contextRegistry[t.target.id];e.view.displayScale/=1.5,e.view.scaleFontSize(1/1.5),e.draw()},this.onClick=function(t){var e=contextRegistry[t.target.id],o=e.view.getOffset(),i=t.clientX-o.x,s=t.clientY-o.y;e.currentTool.onClick(i,s,t)},this.onMouseDown=function(t){var e=contextRegistry[t.target.id],o=e.view.getOffset(),i=t.clientX-o.x,s=t.clientY-o.y;e.currentTool.onMouseDown(i,s,t)},this.onMouseMove=function(t){var e=contextRegistry[t.target.id],o=e.view.getOffset(),i=t.clientX-o.x,s=t.clientY-o.y;e.currentTool.onMouseMove(i,s,t)},this.initEvents=function(t){for(var e in t.widget.registerEvent(t,"click","_center",this.actionCenter),t.widget.registerEvent(t,"click","_chain",this.actionChain),t.widget.registerEvent(t,"click","_minus",this.actionChargeDec),t.widget.registerEvent(t,"click","_plus",this.actionChargeInc),t.widget.registerEvent(t,"click","_copy",this.actionCopy),t.widget.registerEvent(t,"click","_clear",this.actionClear),t.widget.registerEvent(t,"click","_double_bond",this.actionDoubleBond),t.widget.registerEvent(t,"click","_eraser",this.actionEraser),t.widget.registerEvent(t,"click","_hashed_wedge",this.actionHashedWedge),t.widget.registerEvent(t,"click","_info",this.actionInfo),t.widget.registerEvent(t,"click","_isotope",this.actionIsotope),t.widget.registerEvent(t,"click","_isotope_down",this.actionIsotope),t.widget.registerEvent(t,"click","_isotope_up",this.actionIsotope),t.widget.registerEvent(t,"click","_paste",this.actionPasteButton),t.widget.registerEvent(t,"click","_pointer",this.actionPointer),t.widget.registerEvent(t,"click","_redo",this.actionRedo),t.widget.registerEvent(t,"click","_no_radical",this.actionRadical),t.widget.registerEvent(t,"click","_radical",this.actionRadical),t.widget.registerEvent(t,"click","_doublet",this.actionRadical),t.widget.registerEvent(t,"click","_singlet",this.actionRadical),t.widget.registerEvent(t,"click","_triplet",this.actionRadical),t.widget.registerEvent(t,"click","_single_bond",this.actionSingleBond),t.widget.registerEvent(t,"click","_slide",this.actionSlide),t.widget.registerEvent(t,"click","_solid_wedge",this.actionSolidWedge),t.widget.registerEvent(t,"click","_triple_bond",this.actionTripleBond),t.widget.registerEvent(t,"click","_template",this.actionTemplate),t.widget.registerEvent(t,"click","_undo",this.actionUndo),t.widget.registerEvent(t,"click","_zoom_in",this.actionZoomIn),t.widget.registerEvent(t,"click","_zoom_out",this.actionZoomOut),t.widget.registerEvent(t,"click","_canvas",this.onClick),t.widget.registerEvent(t,"click","_hydrogen",this.actionHydrogen),t.widget.registerEvent(t,"click","_carbon",this.actionCarbon),t.widget.registerEvent(t,"click","_nitrogen",this.actionNitrogen),t.widget.registerEvent(t,"click","_oxygen",this.actionOxygen),t.widget.registerEvent(t,"click","_customElement",this.actionCustomElement),t.widget.registerEvent(t,"mousedown","_canvas",this.onMouseDown),t.widget.registerEvent(t,"mousemove","_canvas",this.onMouseMove),t.widget.registerEvent(t,"paste","_canvas",this.actionPaste),this.molpaint.getTemplates())t.widget.registerEvent(t,"click","_"+e,this.actionTemplate)},this.registerEvent=function(t,e,o,i){var s=this.widgetId+o,n=document.getElementById(s);contextRegistry[s]=t,n.addEventListener(e,i,!1)},this.renderWidget=function(){this.viewer?this.widgetObject.innerHTML=this.renderCanvas():this.widgetObject.innerHTML="<table><tr><td colspan=3><table><tr>"+this.renderTopMenu()+"</tr></table></td></tr><tr><td class='leftMenubar'><table>"+this.renderLeftMenu()+"</table></td><td>"+this.renderCanvas()+"</td><td class='rightMenubar'><table>"+this.renderRightMenu()+"</table></td></tr><tr><td colspan=3><table><tr>"+this.renderBottomMenu()+"</tr></table></td></tr></table>"},this.item=function(t,e,o,i){return"<img id='"+this.widgetId+"_"+t+"' width='"+this.iconSize+"' src='"+this.installPath+"img/"+e+".png' title='"+o+"' class='"+i+"' />"},this.eItem=function(t,e,o){return"<tr><td><div id='"+this.widgetId+"_"+t+"' class='inactiveTool' style='height:"+this.iconSize+"px; width:"+this.iconSize+"px; line-height:"+this.iconSize+"px; color:"+o+"'>"+e+"</div></td></tr>"},this.hItem=function(t,e,o){return"<td>"+this.item(t,t,e,o)+"</td>"},this.vItem=function(t,e,o){return"<tr>"+this.hItem(t,e,o)+"</tr>"},this.renderBottomMenu=function(){return""},this.renderBondMenu=function(){return"<tr><td><div class='leftDropdown'>  <a href='javascript:void(0);' class='dropbtn' onclick=\"Widget.prototype.setCurrentBond('"+this.widgetId+"');\" >"+this.item("currentBond","single_bond","","inactiveTool")+"</a><div class='leftDropdown-content'><table><tr>"+this.hItem("single_bond","Single bond","inactiveTool")+this.hItem("double_bond","Double bond","inactiveTool")+this.hItem("triple_bond","Triple bond","inactiveTool")+"    </tr><tr>"+this.hItem("solid_wedge","Solid wedge","inactiveTool")+this.hItem("dashed_bond","Dashed bond","inactiveTool")+this.hItem("wavy_bond","Wavy bond","inactiveTool")+"    </tr><tr>"+this.hItem("hashed_wedge","Hashed Wedge","inactiveTool")+"    <td></td><td></td></tr></table>  </div></div></td></tr>"},this.renderCanvas=function(){return"<canvas id='"+this.widgetId+"_canvas' width='"+this.width+"' height='"+this.height+"' class='canvas' contenteditable='true' >Sorry, your browser does not support the canvas element.</canvas>"},this.renderIsotopeMenu=function(){return"<tr><td><div class='rightDropdown'>  <a href='javascript:void(0);' class='dropbtn'>"+this.item("isotope","isotope_up","Isotope menu","inactiveTool")+"</a><div class='rightDropdown-content'><table>"+this.vItem("isotope_up","Heavier isotope","inactiveTool")+this.hItem("isotope_down","Lighter isotope","inactiveTool")+"</table>  </div></div></td></tr>"},this.renderLeftMenu=function(){return this.vItem("pointer","Select, Translate, Rotate","activeTool")+this.vItem("eraser","Eraser","inactiveTool")+this.renderBondMenu()+this.vItem("chain","Chain","inactiveTool")+this.renderTemplateMenu()+this.vItem("plus","Increment charge","inactiveTool")+this.vItem("minus","Decrement charge","inactiveTool")},this.renderPeriodicTable=function(){var t="<tr><td><div class='rightDropdown'><a href='javascript:void(0);' class='dropbtn'><img id='"+this.widgetId+"_pse' src='img/pse.png' title='Periodic table' width='"+this.iconSize+"' class='inactiveTool' /></a>  <div class='rightDropdown-content'>  <table class='elementTable'>",e="<tr>",o=1,i=1;for(var s in Elements.instance.elements){var n=Elements.instance.elements[s][0];n.getPeriod()>o&&(i=1,e+="</tr><tr>",(o=n.getPeriod())>7&&(8==o&&(e+="<td colspan='18' style='height:8px'></td></tr><tr>"),e+="<td colspan=2></td>",i=2));var r=n.getGroup()-i-1;i=n.getGroup(),r>0&&(e+="<td colspan='"+r+"'></td>"),e+="<td><a href='javascript:void(0)' class='elementLink' onclick=\"Widget.prototype.setElement('"+this.widgetId+"','"+n.getSymbol()+"');\"><span style='color: "+n.getColor()+";'>"+n.getSymbol()+"</span></a></td>"}return t+(e+="</tr>")+"</table></div></div></td></tr>"},this.renderRadicalMenu=function(){return"<tr><td><div class='rightDropdown'>  <a href='javascript:void(0);' class='dropbtn' >"+this.item("radical","radical","Radicals menu","inactiveTool")+"</a><div class='rightDropdown-content'><table><tr>"+this.hItem("no_radical","no radical","inactiveTool")+this.hItem("singlet","Singlet","inactiveTool")+"</tr><tr>"+this.hItem("doublet","Doublet","inactiveTool")+this.hItem("triplet","Triplet","inactiveTool")+"</tr></table>  </div></div></td></tr>"},this.renderRightMenu=function(){return this.renderPeriodicTable()+this.eItem("hydrogen","H",Elements.instance.getElement("H").getColor())+this.eItem("carbon","C",Elements.instance.getElement("C").getColor())+this.eItem("nitrogen","N",Elements.instance.getElement("N").getColor())+this.eItem("oxygen","O",Elements.instance.getElement("O").getColor())+this.eItem("customElement","","#000000")+this.renderIsotopeMenu()+this.renderRadicalMenu()},this.renderTemplateMenu=function(){var t=contextRegistry[this.widgetId].currentTemplate,e="<tr><td><div class='leftDropdown'> <a href='javascript:void(0);' class='dropbtn' >"+this.item("template",t,t,"inactiveTool")+"</a><div class='leftDropdown-content'><table>",o="",i=0;for(var s in this.molpaint.getTemplates())i%5==0&&(o+="<tr>"),i++,o+=this.hItem(s,s,"inactiveTool"),i%5==0&&(o+="</tr>");if(i%5!=0){for(;i%5;)i++,o+="<td></td>";o+="</tr>"}return e+o+"</table></div></div></td></tr>"},this.renderTopMenu=function(){return this.hItem("clear","Clear","defaultTool")+this.hItem("undo","Undo","defaultTool")+this.hItem("redo","Redo","defaultTool")+this.hItem("center","Center","inactiveTool")+this.hItem("slide","Slide","inactiveTool")+this.hItem("copy","Copy","defaultTool")+this.hItem("paste","Paste","defaultTool")+this.hItem("zoom_in","Zoom in","defaultTool")+this.hItem("zoom_out","Zoom out","defaultTool")+this.hItem("info","Info","defaultTool")}}function MolPaintJS(e){this.getContext=function(t){return contextRegistry[t]},this.getMDLv2000=function(t){return(new MDLv2000Writer).write(contextRegistry[t].molecule)},this.getProperties=function(){return this.properties},this.getTemplate=function(t){return this.templates[t]},this.getTemplates=function(){return this.templates},this.setTemplates=function(e){for(t of e)this.templates[t]="",this.loadTemplate(t)},this.dump=function(t,e){document.getElementById(e).innerHTML="<pre>"+this.getMDLv2000(t)+"</pre>"},this.loadTemplate=function(t){var e=this,o=t,i=new XMLHttpRequest,s=this.properties.installPath+"templates/"+t+".mol";i.open("GET",s,!0),i.overrideMimeType("text/html"),i.send(null),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&(e.templates[o]=i.responseText)}},this.newContext=function(t,e){var o=new DefaultProperties(this.properties);return o.setProperties(e),new Context(t,o,this)},this.properties=new DefaultProperties(e),this.templates={},this.setTemplates(["benzene","cyclohexane","cyclopentane"])}Elements.instance=new Elements,function(t){"use strict";var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};function o(){var t=arguments[0],e=o.cache;return e[t]&&e.hasOwnProperty(t)||(e[t]=o.parse(t)),o.format.call(null,e[t],arguments)}o.format=function(t,i){var n,a,c,h,l,d,u,m=1,p=t.length,g="",f=[],w=!0,x="";for(a=0;a<p;a++)if("string"===(g=s(t[a])))f[f.length]=t[a];else if("array"===g){if((h=t[a])[2])for(n=i[m],c=0;c<h[2].length;c++){if(!n.hasOwnProperty(h[2][c]))throw new Error(o('[sprintf] property "%s" does not exist',h[2][c]));n=n[h[2][c]]}else n=h[1]?i[h[1]]:i[m++];if(e.not_type.test(h[8])&&e.not_primitive.test(h[8])&&"function"==s(n)&&(n=n()),e.numeric_arg.test(h[8])&&"number"!=s(n)&&isNaN(n))throw new TypeError(o("[sprintf] expecting number but found %s",s(n)));switch(e.number.test(h[8])&&(w=n>=0),h[8]){case"b":n=parseInt(n,10).toString(2);break;case"c":n=String.fromCharCode(parseInt(n,10));break;case"d":case"i":n=parseInt(n,10);break;case"j":n=JSON.stringify(n,null,h[6]?parseInt(h[6]):0);break;case"e":n=h[7]?parseFloat(n).toExponential(h[7]):parseFloat(n).toExponential();break;case"f":n=h[7]?parseFloat(n).toFixed(h[7]):parseFloat(n);break;case"g":n=h[7]?parseFloat(n).toPrecision(h[7]):parseFloat(n);break;case"o":n=n.toString(8);break;case"s":n=String(n),n=h[7]?n.substring(0,h[7]):n;break;case"t":n=String(!!n),n=h[7]?n.substring(0,h[7]):n;break;case"T":n=s(n),n=h[7]?n.substring(0,h[7]):n;break;case"u":n=parseInt(n,10)>>>0;break;case"v":n=n.valueOf(),n=h[7]?n.substring(0,h[7]):n;break;case"x":n=parseInt(n,10).toString(16);break;case"X":n=parseInt(n,10).toString(16).toUpperCase()}e.json.test(h[8])?f[f.length]=n:(!e.number.test(h[8])||w&&!h[3]?x="":(x=w?"+":"-",n=n.toString().replace(e.sign,"")),d=h[4]?"0"===h[4]?"0":h[4].charAt(1):" ",u=h[6]-(x+n).length,l=h[6]&&u>0?r(d,u):"",f[f.length]=h[5]?x+n+l:"0"===d?x+l+n:l+x+n)}return f.join("")},o.cache={},o.parse=function(t){for(var o=t,i=[],s=[],n=0;o;){if(null!==(i=e.text.exec(o)))s[s.length]=i[0];else if(null!==(i=e.modulo.exec(o)))s[s.length]="%";else{if(null===(i=e.placeholder.exec(o)))throw new SyntaxError("[sprintf] unexpected placeholder");if(i[2]){n|=1;var r=[],a=i[2],c=[];if(null===(c=e.key.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(r[r.length]=c[1];""!==(a=a.substring(c[0].length));)if(null!==(c=e.key_access.exec(a)))r[r.length]=c[1];else{if(null===(c=e.index_access.exec(a)))throw new SyntaxError("[sprintf] failed to parse named argument key");r[r.length]=c[1]}i[2]=r}else n|=2;if(3===n)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");s[s.length]=i}o=o.substring(i[0].length)}return s};var i=function(t,e,i){return(i=(e||[]).slice(0)).splice(0,0,t),o.apply(null,i)};function s(t){return"number"==typeof t?"number":"string"==typeof t?"string":Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}var n={0:["","0","00","000","0000","00000","000000","0000000"]," ":[""," ","  ","   ","    ","     ","      ","       "],_:["","_","__","___","____","_____","______","_______"]};function r(t,e){return e>=0&&e<=7&&n[t]?n[t][e]:Array(e+1).join(t)}"undefined"!=typeof exports&&(exports.sprintf=o,exports.vsprintf=i),void 0!==t&&(t.sprintf=o,t.vsprintf=i,"function"==typeof define&&define.amd&&define(function(){return{sprintf:o,vsprintf:i}}))}("undefined"==typeof window?this:window),Tools.abort=function(t){var e=t.context.contextId+"_"+t.id;document.getElementById(e).className="inactiveTool"},Tools.setup=function(t){var e=t.context.contextId+"_"+t.id;document.getElementById(e).className="activeTool";try{t.setup()}catch(t){}},Widget.prototype.setElement=function(t,e){var o=contextRegistry[t];o.currentElement=Elements.instance.getElement(e),o.widget.actionCustomElement({target:{id:t}})},Widget.prototype.setCurrentBond=function(t){var e=contextRegistry[t];e.setCurrentTool(e.currentBondTool)};